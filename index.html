<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>Mahjong Scoreboard</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f9f9f9; }
  h1, h2 { color: #2c3e50; }
  .container { background: #fff; padding: 20px; border-radius: 10px; max-width: 900px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
  label { display: block; margin-top: 10px; font-weight: bold; }
  input, select, button { margin-top: 5px; padding: 8px; width: 100%; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #ecf0f1; }
  .totals { margin-top: 20px; padding: 15px; background: #ecf0f1; border-radius: 8px; font-weight: bold; }
  .small-btn { padding: 5px 10px; font-size: 0.8em; margin-left:5px; }
@media (max-width: 600px) {
      body {
        font-size: 14px;
        padding: 5px;
      }

      input, select, button {
        width: 100%;
        margin: 4px 0;
        font-size: 14px;
        padding: 6px;
      }

      table {
        font-size: 12px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }

      button {
        border-radius: 8px;
        padding: 8px;
      }

      #whoPaysWho {
        font-size: 13px;
      }
    }
</style>
</head>
<body>


<div class="container">
  <h1>Mahjong Scoreboard</h1>

  <!-- Player Names & Animal Assignment -->
  <label>Player Names & Animals</label>
  <div id="playerSetup">
    <input type="text" id="p1" placeholder="Player 1"> 

    <input type="text" id="p2" placeholder="Player 2">

    <input type="text" id="p3" placeholder="Player 3">

    <input type="text" id="p4" placeholder="Player 4">
  </div>

  <!-- House Rules Configuration -->
  <h2>House Rules Config</h2>
  <label>Animal Payouts</label>
  <input type="number" id="animalStart" placeholder="Start-of-Game Payout">
  <input type="number" id="animalIn" placeholder="In-Game Payout">

  <label>Flower Payouts</label>
  <input type="number" id="flowerStart" placeholder="Start-of-Game Payout">
  <input type="number" id="flowerIn" placeholder="In-Game Payout">

  <label>Gang Payouts</label>
  <input type="number" id="gangConcealed" placeholder="Concealed Gang">
  <input type="number" id="gangRevealed" placeholder="Revealed Gang (Shooter Pay)">
</div>

<!-- Special Events Section -->
<div class="container">
  <h2>Special Events (Animals, Flowers, Gang)</h2>

  <label>Player</label>
  <select id="eventPlayer">
    <option value="p1">Player 1</option>
    <option value="p2">Player 2</option>
    <option value="p3">Player 3</option>
    <option value="p4">Player 4</option>
  </select>

  <label>Event Type</label>
  <select id="eventType" onchange="updateEventDetailOptions()">
    <option value="animal">Animal</option>
    <option value="flower">Flower</option>
    <option value="gang">Gang</option>
  </select>

  <label>Event Detail</label>
  <select id="eventDetail"></select>

  <label id="timingLabel">Timing</label>
  <select id="eventTiming">
    <option value="start">Start-of-Game</option>
    <option value="in">In-Game</option>
  </select>

  <label id="shooterLabel">Shooter (if Revealed Gang)</label>
  <select id="eventShooter">
    <option value="p1">Player 1</option>
    <option value="p2">Player 2</option>
    <option value="p3">Player 3</option>
    <option value="p4">Player 4</option>
  </select>

  <button onclick="addEvent()">Add Event</button>
</div>

<!-- New Round Section -->
<div class="container">
  <h2>New Round</h2>

  <label>Winner</label>
  <select id="winner">
    <option value="p1">Player 1</option>
    <option value="p2">Player 2</option>
    <option value="p3">Player 3</option>
    <option value="p4">Player 4</option>
  </select>

  <label>Number of Tai (1â€“5)</label>
  <select id="tai">
    <option value="1">1</option><option value="2">2</option><option value="3">3</option>
    <option value="4">4</option><option value="5">5</option>
  </select>

  <label>Win Type</label>
  <select id="winType" onchange="toggleShooterDropdown()">
    <option value="shooter">Shooter Pay</option>
    <option value="selfdraw">Self-Draw</option>
  </select>

  <div id="shooterDiv" style="display:block;">
    <label>Shooter (Discarder)</label>
    <select id="shooter">
      <option value="p1">Player 1</option>
      <option value="p2">Player 2</option>
      <option value="p3">Player 3</option>
      <option value="p4">Player 4</option>
    </select>
  </div>

  <label>Game Rate</label>
  <select id="rate">
    <option value="10_20">10Â¢ / 20Â¢</option>
    <option value="20_40">20Â¢ / 40Â¢</option>
    <option value="30_60" selected>30Â¢ / 60Â¢</option>
    <option value="50_1">50Â¢ / $1</option>
    <option value="1_2">$1 / $2</option>
  </select>

  <button onclick="addRound()">Add Round</button>
</div>

<!-- Scoreboard Section -->
<div class="container">
  <h2>Scoreboard</h2>
  <table id="scoreTable">
    <thead>
      <tr>
        <th>Round</th>
        <th>Winner</th>
        <th>Details</th>
        <th>P1</th>
        <th>P2</th>
        <th>P3</th>
        <th>P4</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totals" id="totals">Totals: 0 | 0 | 0 | 0</div>

  <label>Divide Payout</label>
  <select id="dividePayout" onchange="updateDivideTotals()">
    <option value="1">No Divide</option>
    <option value="2">/2</option>
    <option value="3">/3</option>
    <option value="4">/4</option>
  </select>

  <div id="divideTotals" class="totals"></div>
  <button onclick="calculateSettlement()">Calculate Settlement</button>
<div id="whoPaysWho" style="margin-top:10px; max-height:200px; overflow-y:auto;"></div>
  <button onclick="resetAllRounds()" class="small-btn">Reset All Rounds</button>
</div>
<script>
  // ======== Global Variables ========
  let roundNumber = 0;
  let totals = {p1:0,p2:0,p3:0,p4:0};
  let assignedAnimals = {};
  
  // Default payout tables for normal rounds
  const payoutTables = {
    "10_20": {1:{s:0.40,d:0.20},2:{s:0.80,d:0.40},3:{s:1.60,d:0.80},4:{s:3.20,d:1.60},5:{s:6.40,d:3.20}},
    "20_40": {1:{s:0.80,d:0.40},2:{s:1.60,d:0.80},3:{s:3.20,d:1.60},4:{s:6.40,d:3.20},5:{s:12.80,d:6.40}},
    "30_60": {1:{s:4,d:2},2:{s:7,d:3},3:{s:11,d:5},4:{s:20,d:10},5:{s:40,d:20}},
    "50_1": {1:{s:2,d:1},2:{s:4,d:2},3:{s:8,d:4},4:{s:16,d:8},5:{s:32,d:16}},
    "1_2": {1:{s:4,d:2},2:{s:8,d:4},3:{s:16,d:8},4:{s:32,d:16},5:{s:64,d:32}}
  };
  
  // ======== Utility Functions ========
  
  // Get player names
  function getPlayerNames(){
    return {
      p1: document.getElementById('p1').value || "Player 1",
      p2: document.getElementById('p2').value || "Player 2",
      p3: document.getElementById('p3').value || "Player 3",
      p4: document.getElementById('p4').value || "Player 4"
    };
  }
  
  // Get assigned animals
  function updateAssignedAnimals(){
    // assignedAnimals = {
    //   p1: document.getElementById('a1').value,
    //   p2: document.getElementById('a2').value,
    //   p3: document.getElementById('a3').value,
    //   p4: document.getElementById('a4').value
    // };
  }
  
  // Update event detail options based on type
  function updateEventDetailOptions(){
    const type = document.getElementById('eventType').value;
    const detail = document.getElementById('eventDetail');
    detail.innerHTML = '';
    if(type==='animal'){
      detail.innerHTML = '<option value="own">Own Animal</option><option value="pair">Animal Pair</option>';
      document.getElementById('eventTiming').style.display='block';
      document.getElementById('timingLabel').style.display='block';
      document.getElementById('shooterLabel').style.display='none';
      document.getElementById('eventShooter').style.display='none';
    }else if(type==='flower'){
      detail.innerHTML = '<option value="own">Own Number</option><option value="same">Same Number</option>';
      document.getElementById('eventTiming').style.display='block';
      document.getElementById('timingLabel').style.display='block';
      document.getElementById('shooterLabel').style.display='none';
      document.getElementById('eventShooter').style.display='none';
    }else if(type==='gang'){
      detail.innerHTML = '<option value="concealed">Concealed Gang</option><option value="revealed">Revealed Gang</option>';
      document.getElementById('eventTiming').style.display='none';
      document.getElementById('timingLabel').style.display='none';
      document.getElementById('shooterLabel').style.display='block';
      document.getElementById('eventShooter').style.display='block';
    }
  }
  
  // Update totals display
  function updateTotals(){
    const names = getPlayerNames();
    const t = totals;
    document.getElementById("totals").innerHTML = 
      `Totals: ${names.p1} $${t.p1.toFixed(2)} | ${names.p2} $${t.p2.toFixed(2)} | ${names.p3} $${t.p3.toFixed(2)} | ${names.p4} $${t.p4.toFixed(2)}`;
    updateDivideTotals();
  }
  
  // Delete a row and adjust totals
  function deleteRow(row, delta){
    for(let p in delta) totals[p]-=delta[p];
    row.remove();
    updateTotals();
  }
  
  // Toggle shooter for normal rounds
  function toggleShooterDropdown(){
    const winType = document.getElementById('winType').value;
    document.getElementById('shooterDiv').style.display = (winType==="shooter")?"block":"none";
  }
  
  // Update divide payout display
  function updateDivideTotals(){
    const divideBy = parseInt(document.getElementById('dividePayout').value);
    const t = totals;
    const names = getPlayerNames();
    const dividedText = 
      `Divided Totals (by ${divideBy}): ${names.p1} $${(t.p1/divideBy).toFixed(2)} | ${names.p2} $${(t.p2/divideBy).toFixed(2)} | ${names.p3} $${(t.p3/divideBy).toFixed(2)} | ${names.p4} $${(t.p4/divideBy).toFixed(2)}`;
    document.getElementById('divideTotals').innerHTML = dividedText;
  }
  
  // Initialize on page load
  window.onload = function(){
    updateEventDetailOptions();
    updateAssignedAnimals();
    updateDivideTotals();
  }
  </script>
<script>
  // ======== Add Normal Round ========
  function addRound(){
    updateAssignedAnimals();
    const names = getPlayerNames();
    const winner = document.getElementById('winner').value;
    const tai = parseInt(document.getElementById('tai').value);
    const rate = document.getElementById('rate').value;
    const winType = document.getElementById('winType').value;
    const payout = payoutTables[rate][tai];
  
    let delta = {p1:0,p2:0,p3:0,p4:0};
    let detail = '';
    roundNumber++;
  
    if(winType==='shooter'){
      const shooter = document.getElementById('shooter').value;
      if(shooter===winner){ alert("Winner cannot be shooter!"); return; }
      delta[winner]+=payout.s;
      delta[shooter]-=payout.s;
      detail = `${names[winner]} wins ${tai} tai, ${names[shooter]} pays $${payout.s.toFixed(2)}`;
    } else {
      delta[winner]+=payout.d*3;
      for(let p of ['p1','p2','p3','p4']){ if(p!==winner) delta[p]-=payout.d; }
      detail = `${names[winner]} wins ${tai} tai self-draw, others pay $${payout.d.toFixed(2)}`;
    }
  
    for(let p in totals) totals[p]+=delta[p];
  
    const row = document.createElement('tr');
    row.innerHTML = `<td>${roundNumber}</td><td>${names[winner]}</td><td>${detail}</td>
                     <td>${delta.p1.toFixed(2)}</td><td>${delta.p2.toFixed(2)}</td>
                     <td>${delta.p3.toFixed(2)}</td><td>${delta.p4.toFixed(2)}</td>`;
  
    // Add delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "ðŸ—‘ï¸";
    deleteBtn.className = "small-btn";
    deleteBtn.onclick = ()=>deleteRow(row, delta);
    row.cells[0].appendChild(deleteBtn);
  
    document.querySelector("#scoreTable tbody").appendChild(row);
    updateTotals();
  }
  
  // ======== Add Special Event ========
  function addEvent(){
    updateAssignedAnimals();
    const names = getPlayerNames();
    const player = document.getElementById('eventPlayer').value;
    const type = document.getElementById('eventType').value;
    const detailType = document.getElementById('eventDetail').value;
    const timing = document.getElementById('eventTiming').value;
    const shooter = document.getElementById('eventShooter').value;
  
    // House rule values
    const animalStart = parseFloat(document.getElementById('animalStart').value);
    const animalIn = parseFloat(document.getElementById('animalIn').value);
    const flowerStart = parseFloat(document.getElementById('flowerStart').value);
    const flowerIn = parseFloat(document.getElementById('flowerIn').value);
    const gangConcealed = parseFloat(document.getElementById('gangConcealed').value);
    const gangRevealed = parseFloat(document.getElementById('gangRevealed').value);
  
    let delta = {p1:0,p2:0,p3:0,p4:0};
    let detail = '';
    roundNumber++;
  
    if(type==='animal'){
      const amt = (timing==='start') ? animalStart : animalIn;
      if(detailType==='own'){
        for(let p in delta){ if(p!==player) delta[p]-=amt; else delta[p]+=amt*3; }
        detail = `${names[player]} drew Own Animal (${timing}) +$${amt*3}`;
      } else { // pair
        const total = amt*2;
        for(let p in delta){ if(p!==player) delta[p]-=total; else delta[p]+=total*3; }
        detail = `${names[player]} drew Animal Pair (${timing}) +$${total*3}`;
      }
    } else if(type==='flower'){
      const amt = (timing==='start') ? flowerStart : flowerIn;
      if(detailType==='own'){
        for(let p in delta){ if(p!==player) delta[p]-=amt; else delta[p]+=amt*3; }
        detail = `${names[player]} drew Flower Own Number (${timing}) +$${amt*3}`;
      } else { // same
        const total = amt;
        let payer=''; 
        for(let p of ['p1','p2','p3','p4']){ if(p!==player){ payer=p; break; } }
        delta[player]+=total; delta[payer]-=total;
        detail = `${names[player]} drew Flower Same Number (${timing}) +$${total} from ${names[payer]}`;
      }
    } else if(type==='gang'){
      if(detailType==='concealed'){
        for(let p in delta){ if(p!==player) delta[p]-=gangConcealed; else delta[p]+=gangConcealed*3; }
        detail = `${names[player]} did Concealed Gang +$${gangConcealed*3}`;
      } else {
        delta[player]+=gangRevealed;
        delta[shooter]-=gangRevealed;
        detail = `${names[player]} did Revealed Gang, ${names[shooter]} pays $${gangRevealed}`;
      }
    }
  
    for(let p in totals) totals[p]+=delta[p];
  
    const row = document.createElement('tr');
    row.innerHTML = `<td>${roundNumber}</td><td>${names[player]}</td><td>${detail}</td>
                     <td>${delta.p1.toFixed(2)}</td><td>${delta.p2.toFixed(2)}</td>
                     <td>${delta.p3.toFixed(2)}</td><td>${delta.p4.toFixed(2)}</td>`;
  
    // Delete button
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "ðŸ—‘ï¸";
    deleteBtn.className = "small-btn";
    deleteBtn.onclick = ()=>deleteRow(row, delta);
    row.cells[0].appendChild(deleteBtn);
  
    document.querySelector("#scoreTable tbody").appendChild(row);
    updateTotals();
  }
  
  // ======== Reset All Rounds ========
  function resetAllRounds(){
    if(!confirm("Are you sure you want to reset all rounds?")) return;
    document.querySelector("#scoreTable tbody").innerHTML='';
    roundNumber=0;
    totals={p1:0,p2:0,p3:0,p4:0};
    updateTotals();
  }

  function calculateSettlement(){
  const divideBy = parseInt(document.getElementById('dividePayout').value);
  const names = getPlayerNames();
  
  // Prepare balances after dividing
  let balances = {
    p1: (totals.p1 / divideBy),
    p2: (totals.p2 / divideBy),
    p3: (totals.p3 / divideBy),
    p4: (totals.p4 / divideBy)
  };

  // Separate creditors and debtors
  let creditors = [], debtors = [];
  for(let p in balances){
    const amt = parseFloat(balances[p].toFixed(2));
    if(amt > 0) creditors.push({player:p, amount:amt});
    else if(amt < 0) debtors.push({player:p, amount:-amt}); // store positive for calculation
  }

  const results = [];

  let cIndex = 0;
  let dIndex = 0;

  while(dIndex < debtors.length && cIndex < creditors.length){
    let debtor = debtors[dIndex];
    let creditor = creditors[cIndex];

    let pay = Math.min(debtor.amount, creditor.amount);
    pay = parseFloat(pay.toFixed(2));

    results.push(`<span style="color:red;">${names[debtor.player]}</span> pays <span style="color:green;">${names[creditor.player]}</span> $${pay}`);

    debtor.amount -= pay;
    creditor.amount -= pay;

    if(debtor.amount <= 0.001) dIndex++;
    if(creditor.amount <= 0.001) cIndex++;
  }

  // Display results
  const container = document.getElementById('whoPaysWho');
  container.innerHTML = results.join('<br>');
}
  </script>
  </body>
  </html>
